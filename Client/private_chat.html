<!DOCTYPE html>
<html lang="en">

<head>
  <title>Chatroom Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/chat.css">
</head>

<body>
  <div id="app">
    <nav class="navbar navbar-inverse">
      <a class="navbar-brand" href="#">Chatroom Example</a>
    </nav>
    <div class="container-fluid">
      <div class="row">
        <main class="col-sm-12 messages-main">
          <div class="row messages-header">
            <div class="col-sm-10">
              Private Chat
            </div>
            <div class="col-sm-2">
              <a href="get_chat_list.html" id="back">Back</a>
            </div>
          </div>
          <div class="row messages-body" v-cloak>
            <div class="col-sm-12">
              <ul class="list-group message-group">
                <li class="list-group-item message-item d-flex" v-for="message in messages" track-by="$index">
                  <img v-bind:src="message.avatar" class="rounded-circle float-left mr-2"> {{ message }}
                  <hr>
                  <small class="text-muted">{{ username }} @ {{ date }}</small>
                </li>
              </ul>
            </div>
          </div>
          <div class="row messages-footer">
            <div class="col-sm-2">
              <input type="text" class="form-control" id="to" placeholder="To">
            </div>
            <div class="col-sm-10 input-group">
              <input type="text" class="form-control" v-focus="true" v-model="message" v-on:keyup.enter="send" placeholder="Message text...">
              <span class="input-group-btn">
                  <button class="btn btn-primary" type="button">Send</button>
                </span>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.2/dist/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script>
  function _mapUrlParams(queryString) {
    return queryString    
      .split('&') 
      .map(function(keyValueString) { return keyValueString.split('=') })
      .reduce(function(urlParams, [key, value]) {
        if (Number.isInteger(parseInt(value)) && parseInt(value) == value) {
          urlParams[key] = parseInt(value);
        } else {
          urlParams[key] = decodeURI(value);
        }
        return urlParams;
      }, {});
  }
  let urlParams = new URLSearchParams(window.location.search)
  let queryString = (_mapUrlParams(urlParams.toString()))
  let { chat_token, uuid } = queryString
  console.log(chat_token, uuid)

  $("#back").attr('href', `get_chat_list.html?uuid=${uuid}`)

  if(uuid){
    let socket = io.connect('http://localhost:3000', { reconnect: true, connect_timeout: 5000 })
    socket.on("connect", () => {
      let socket_id = socket.id
      console.log('get_chat_history', { chat_token, socket_id })
      socket.emit('get_chat_history', { chat_token, socket_id })
    })

    socket.on('get_chat_history_result', function(data){
      console.log(data)
    })
  }
</script>
</body>

</html>